import{f as P,u as j,r as u,g as F,C as H,c,a as n,m as x,d as m,H as N,w as b,b as y,F as K,l as q,E as p,D as G,S as h,o as r,n as T,t as g,K as J,U as O,_ as Q}from"./EcDhdyxl.js";import{n as _}from"./OKUTmN9V.js";const W={class:"messages-section"},X={class:"section-header"},Y={class:"section-title"},Z={class:"header-actions"},ee={key:0,class:"loading-container"},te={key:1,class:"placeholder-content"},se={key:2,class:"notifications-list"},oe=["onClick"],ae={class:"notification-header"},ne={class:"notification-time"},re={class:"notification-title"},le={class:"notification-content"},ce={class:"notification-actions"},ie={key:3,class:"load-more"},de=10,ue=P({__name:"messages",setup(pe){j();const o=u([]),l=u(0),k=u(!0),C=u(!1),R=u(!0),M=u(1);let v=null;const B=t=>({receipt_approved:"success",receipt_rejected:"danger",order:"primary",system:"info"})[t]||"info",z=t=>({receipt_approved:"审核通过",receipt_rejected:"审核拒绝",order:"订单消息",system:"系统消息"})[t]||"通知",D=t=>{const e=new Date(t),a=new Date().getTime()-e.getTime(),d=Math.floor(a/(1e3*60*60*24));if(d===0){const f=Math.floor(a/36e5);if(f===0){const s=Math.floor(a/6e4);return s===0?"刚刚":`${s}分钟前`}return`${f}小时前`}else return d===1?"昨天":d<7?`${d}天前`:e.toLocaleDateString("zh-CN")},w=async(t=1)=>{try{const e=await _.getList({page:t,pageSize:de});e.code===0&&(t===1?o.value=e.data.list||[]:o.value.push(...e.data.list||[]),R.value=e.data.total>o.value.length,M.value=t)}catch(e){console.error("获取通知失败:",e),p.error("获取消息失败")}finally{k.value=!1,C.value=!1}},A=async()=>{try{const t=await _.getUnreadCount();t.code===0&&(l.value=t.data.count||0)}catch(t){console.error("获取未读数量失败:",t)}},E=async t=>{if(!t.isRead)try{(await _.markAsRead(t.id)).code===0&&(t.isRead=!0,l.value=Math.max(0,l.value-1))}catch(e){console.error("标记已读失败:",e)}},I=async()=>{try{(await _.markAllAsRead()).code===0&&(o.value.forEach(e=>e.isRead=!0),l.value=0,p.success("已全部标记为已读"))}catch(t){console.error("标记全部已读失败:",t),p.error("操作失败")}},S=async t=>{try{if(await O.confirm("确定要删除这条消息吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),(await _.deleteNotification(t)).code===0){const i=o.value.findIndex(a=>a.id===t);i>-1&&(o.value[i].isRead||(l.value=Math.max(0,l.value-1)),o.value.splice(i,1)),p.success("删除成功")}}catch(e){e!=="cancel"&&(console.error("删除失败:",e),p.error("删除失败"))}},U=()=>{C.value=!0,w(M.value+1)},$=()=>{v=G(()=>{A(),M.value===1&&w(1)},3e4)},L=()=>{v&&(clearInterval(v),v=null)};return F(()=>{w(),A(),$()}),H(()=>{L()}),(t,e)=>{const i=h("el-badge"),a=h("el-button"),d=h("el-skeleton"),f=h("el-empty");return r(),c("div",W,[n("div",X,[n("h2",Y,[e[0]||(e[0]=m(" 我的消息 ")),l.value>0?(r(),N(i,{key:0,value:l.value,class:"unread-badge"},null,8,["value"])):x("",!0)]),n("div",Z,[o.value.length>0?(r(),N(a,{key:0,onClick:I,size:"small",type:"primary"},{default:b(()=>e[1]||(e[1]=[m(" 全部标记为已读 ")])),_:1,__:[1]})):x("",!0)])]),k.value?(r(),c("div",ee,[y(d,{rows:5,animated:""})])):o.value.length===0?(r(),c("div",te,[y(f,{description:"暂无消息"})])):(r(),c("div",se,[(r(!0),c(K,null,q(o.value,s=>(r(),c("div",{key:s.id,class:T(["notification-item",{unread:!s.isRead}]),onClick:V=>E(s)},[n("div",ae,[n("span",{class:T(["notification-type",B(s.type)])},g(z(s.type)),3),n("span",ne,g(D(s.createdAt)),1)]),n("h4",re,g(s.title),1),n("p",le,g(s.content),1),n("div",ce,[y(a,{onClick:J(V=>S(s.id),["stop"]),size:"small",type:"danger",text:""},{default:b(()=>e[2]||(e[2]=[m(" 删除 ")])),_:2,__:[2]},1032,["onClick"])])],10,oe))),128))])),!k.value&&R.value?(r(),c("div",ie,[y(a,{onClick:U,loading:C.value},{default:b(()=>e[3]||(e[3]=[m("加载更多")])),_:1,__:[3]},8,["loading"])])):x("",!0)])}}}),fe=Q(ue,[["__scopeId","data-v-6289acdc"]]);export{fe as default};
