import{f as Ms,u as as,r as y,h as ls,g as Ss,B as Ns,c as n,m as v,H as Ts,a as s,b as $s,t as o,F as x,l as P,K as os,n as N,d as A,s as Ds,L as R,S as xs,o as i,_ as Ps}from"./EcDhdyxl.js";import{R as As}from"./C0puMdAJ.js";const Rs={class:"orders-container"},Os={key:0,class:"loading-state"},Es={key:1,class:"orders-section"},Is={class:"section-header"},Vs={class:"header-right"},Bs={class:"order-stats"},Ls={class:"stat-item"},Fs={class:"stat-count"},Ks={class:"stat-item"},zs={class:"stat-count"},qs={class:"stat-item"},Hs={class:"stat-count"},Js={class:"filter-tabs"},Us=["onClick"],js={key:0,class:"tab-badge"},Gs={key:0,class:"empty-state"},Qs={class:"empty-text"},Ws={class:"empty-desc"},Xs={key:1,class:"orders-list"},Ys={class:"order-header"},Zs={class:"order-meta"},st={class:"order-number"},tt={class:"order-date"},et={class:"order-content"},at={class:"product-info"},lt={class:"product-title"},ot={class:"product-details"},it={key:0,class:"detail-row"},nt={class:"detail-value"},ct={key:1,class:"detail-row"},dt={class:"detail-value"},ut={class:"detail-row"},rt={class:"detail-value"},vt={key:2,class:"detail-row"},pt={class:"detail-value"},mt={key:3,class:"detail-row"},_t={class:"detail-value"},yt={class:"price-info"},ht={class:"total-price"},gt={key:0,class:"unit-price"},ft={class:"order-actions"},kt=["onClick"],bt=["onClick"],Ct=["onClick"],wt=["onClick"],Mt={key:2,class:"pagination"},St=["disabled"],Nt={class:"page-numbers"},Tt=["onClick"],$t=["disabled"],Dt={class:"page-info"},xt={class:"detail-modal"},Pt={key:0,class:"modal-body"},At={class:"detail-section"},Rt={class:"detail-grid"},Ot={class:"detail-item"},Et={class:"value"},It={class:"detail-item"},Vt={class:"value"},Bt={class:"detail-item"},Lt={class:"detail-item"},Ft={class:"value"},Kt={key:0,class:"detail-item"},zt={class:"value"},qt={key:1,class:"detail-item"},Ht={class:"value"},Jt={class:"detail-section"},Ut={class:"detail-grid"},jt={class:"detail-item"},Gt={class:"value"},Qt={class:"detail-item"},Wt={class:"value"},Xt={class:"detail-item"},Yt={class:"value highlight"},Zt={class:"delivery-modal"},se={class:"modal-body"},te={key:0,class:"delivery-content"},ee={class:"info-section"},ae={class:"info-grid"},le={class:"info-item"},oe={class:"value"},ie={class:"info-item"},ne={class:"value"},ce={class:"info-item"},de={class:"value status"},ue={key:0,class:"info-item"},re={class:"value"},ve={key:0,class:"info-section"},pe={class:"cdk-list"},me={class:"cdk-header"},_e={class:"cdk-index"},ye={key:0,class:"cdk-code-wrapper"},he=["value"],ge=["onClick"],fe={key:1,class:"delivery-text"},ke={key:1,class:"empty-delivery"},be={key:5,class:"error-toast"},Ce={class:"toast-content"},we={class:"toast-text"},Me=Ms({__name:"orders",setup(Se){const O=Ds(),q=as(),E=y(!0),f=y(""),b=y([]),_=y("all"),I=y(!1),V=y(!1),B=y(!1),d=y(null),g=y(null),is=y(null),C=y(-1),r=y({page:1,limit:10,total:0,totalPage:0}),M=y([{key:"all",label:"全部",count:0},{key:"shipping",label:"待发货",count:0},{key:"delivered",label:"已发货",count:0}]),H=ls(()=>_.value==="all"?b.value:b.value.filter(e=>T(e)===_.value)),L=ls(()=>{const e={total:b.value.length,shipping:0,delivered:0};return b.value.forEach(t=>{const l=T(t);l==="shipping"?e.shipping++:l==="delivered"&&e.delivered++}),e}),w=async(e=1)=>{if(!q.isLoggedIn){await O.push("/login");return}E.value=!0,f.value="";try{const t={page:e,limit:r.value.limit,paymentStatus:1};_.value!=="all"&&(t.status=ns(_.value));const l=await R.getOrderList(t);if((l.code===0||l.success)&&l.data)b.value=l.data.list||[],r.value={page:l.data.page||1,limit:l.data.limit||10,total:l.data.total||0,totalPage:l.data.totalPage||1},G(),e===1&&K();else if(l.msg==="查询成功"&&l.data)b.value=l.data.list||[],r.value={page:l.data.page||1,limit:l.data.limit||10,total:l.data.total||0,totalPage:l.data.totalPage||1},G(),e===1&&K();else throw new Error(l.msg||"获取订单列表失败")}catch(t){f.value=t.message||"获取订单失败，请稍后重试",D()}finally{E.value=!1}},T=e=>{if(e.paymentStatus===1){if(e.deliveryStatus===0||e.deliveryStatus===1)return"shipping";if(e.deliveryStatus===2||e.deliveryStatus===3)return"delivered"}return"shipping"},ns=e=>{switch(e){case"pending":return 0;case"shipping":return 1;case"delivered":return 2;case"completed":return 4;case"cancelled":return 5;default:return 0}},J=e=>{const t=T(e);return{shipping:"待发货",delivered:"已发货"}[t]||"待发货"},U=e=>{const t=T(e);return{shipping:"status-shipping",delivered:"status-delivered"}[t]||"status-shipping"},S=e=>{if(!e)return"未知时间";try{const t=new Date(e);if(isNaN(t.getTime()))return e;const c=new Date().getTime()-t.getTime(),u=Math.floor(c/(1e3*60*60*24)),p=t.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});if(u<0){const m=Math.abs(u);return m===1?`${p} (明天)`:`${p} (${m}天后)`}else{if(u===0)return`${p} (今天)`;if(u===1)return`${p} (昨天)`;if(u<7)return`${p} (${u}天前)`;if(u<30){const m=Math.floor(u/7);return`${p} (${m}周前)`}else if(u<365){const m=Math.floor(u/30);return`${p} (${m}个月前)`}else{const m=Math.floor(u/365);return`${p} (${m}年前)`}}}catch{return e}},$=e=>e?(typeof e=="string"?parseFloat(e.replace(/[¥,]/g,"")):e).toFixed(2):"0.00",j=e=>({wechat:"微信支付",alipay:"支付宝",binance:"币安支付",balance:"余额支付",2:"微信支付",4:"支付宝",3:"币安支付"})[e]||e||"未知支付方式",cs=async e=>{_.value!==e&&(_.value=e,r.value.page=1,await w(1))},F=async e=>{e<1||e>r.value.totalPage||(r.value.page=e,await w(e))},ds=()=>{const e=r.value.page,t=r.value.totalPage,l=[];t>0&&l.push(1);for(let c=Math.max(2,e-2);c<=Math.min(t-1,e+2);c++)l.includes(c)||l.push(c);return t>1&&!l.includes(t)&&l.push(t),l.sort((c,u)=>c-u)},K=async()=>{try{const t=as().user;if(!(t!=null&&t.id))return;const l={page:1,limit:100,paymentStatus:1};try{const c=await R.getOrderList(l);if((c.code===0||c.success||c.msg==="查询成功")&&c.data){const u=c.data.list||[];let p=0,m=0;u.forEach(k=>{k.deliveryStatus===0||k.deliveryStatus===1?p++:(k.deliveryStatus===2||k.deliveryStatus===3)&&m++}),M.value[0].count=u.length,M.value[1].count=p,M.value[2].count=m}}catch{}}catch{}},G=()=>{const e=M.value.find(t=>t.key===_.value);e&&(e.count=r.value.total||0)},us=e=>e.paymentStatus===1&&e.deliveryStatus===0,rs=e=>e.paymentStatus===1&&(e.deliveryStatus===2||e.deliveryStatus===3),Q=e=>e.deliveryRequiresReceipt||e.hasReceipt||!1,vs=async e=>{if(!confirm("订单已在处理中，确定要取消吗？取消后可能需要等待商家确认。"))return;const l=e.orderNo||e.id;try{const c=await R.cancelOrder(l);if(c.success||c.code===0||c.code===200)await w(r.value.page),z("订单取消申请已提交");else{let u=c.msg||c.message||"取消订单失败";throw u.includes("不能取消")||u.includes("无法取消")?u="该订单当前状态不允许取消，请联系客服处理":u.includes("已发货")?u="订单已发货，无法取消":u.includes("已完成")&&(u="订单已完成，无法取消"),new Error(u)}}catch(c){f.value=c.message||"取消订单失败，请稍后重试",D()}},ps=async e=>{try{const t=e.orderNo||e.id,l=await R.getDeliveryInfo(t);l.success||l.code===200||l.code===0?(g.value=l.data,V.value=!0):(f.value=l.msg||l.message||"获取发货信息失败",D())}catch(t){f.value=t.message||"获取发货信息失败，请稍后重试",D()}},ms=async e=>{d.value=e,B.value=!0},_s=()=>{w(r.value.page)},ys=()=>{B.value=!1,is.value=null},W=()=>{V.value=!1,g.value=null,C.value=-1},hs=e=>({0:"待发货",1:"部分发货",2:"已发货",3:"已送达"})[e]||"未知",gs=e=>{try{return JSON.parse(e).cdkCode||e}catch{return e}},fs=async(e,t)=>{try{await navigator.clipboard.writeText(e),C.value=t,z("CDK已复制到剪贴板"),setTimeout(()=>{C.value=-1},2e3)}catch{const c=document.createElement("input");c.value=e,document.body.appendChild(c),c.select(),document.execCommand("copy"),document.body.removeChild(c),C.value=t,z("CDK已复制到剪贴板"),setTimeout(()=>{C.value=-1},2e3)}},ks=e=>{d.value=e,I.value=!0},X=()=>{I.value=!1,d.value=null},bs=()=>{_.value==="all"?O.push("/"):(_.value="all",w(1))},Cs=()=>({all:"暂无订单",shipping:"暂无待发货订单",delivered:"暂无已发货订单"})[_.value]||"暂无相关订单",ws=()=>({all:"您还没有任何订单",shipping:"您还没有待发货的订单",delivered:"您还没有已发货的订单"})[_.value]||"暂无相关订单数据",z=e=>{const t=document.createElement("div");t.className="success-toast",t.innerHTML=`
    <div class="toast-content">
      <span class="toast-icon">✅</span>
      <span class="toast-text">${e}</span>
    </div>
  `,document.body.appendChild(t),setTimeout(()=>{document.body.removeChild(t)},3e3)},D=()=>{setTimeout(()=>{f.value=""},5e3)};return Ss(()=>{w(),K()}),Ns(()=>q.isLoggedIn,e=>{e||O.push("/login")}),(e,t)=>{var c,u,p,m,k,Y,Z,ss,ts,es;const l=xs("NotificationBell");return i(),n("div",Rs,[E.value?(i(),n("div",Os,t[2]||(t[2]=[s("div",{class:"loading-spinner"},null,-1),s("div",{class:"loading-text"},"加载订单中...",-1)]))):(i(),n("div",Es,[s("div",Is,[t[6]||(t[6]=s("h2",{class:"section-title"},"我的订单",-1)),s("div",Vs,[$s(l),s("div",Bs,[s("div",Ls,[s("span",Fs,o(L.value.total),1),t[3]||(t[3]=s("span",{class:"stat-label"},"全部",-1))]),s("div",Ks,[s("span",zs,o(L.value.shipping),1),t[4]||(t[4]=s("span",{class:"stat-label"},"待发货",-1))]),s("div",qs,[s("span",Hs,o(L.value.delivered),1),t[5]||(t[5]=s("span",{class:"stat-label"},"已发货",-1))])])])]),s("div",Js,[(i(!0),n(x,null,P(M.value,a=>(i(),n("div",{key:a.key,class:N(["filter-tab",{active:_.value===a.key}]),onClick:h=>cs(a.key)},[A(o(a.label)+" ",1),a.count>0?(i(),n("span",js,o(a.count),1)):v("",!0)],10,Us))),128))]),H.value.length===0?(i(),n("div",Gs,[t[7]||(t[7]=s("div",{class:"empty-icon"},"📦",-1)),s("div",Qs,o(Cs()),1),s("div",Ws,o(ws()),1),s("button",{class:"go-shopping-btn",onClick:bs},o(_.value==="all"?"去购物":"查看全部订单"),1)])):(i(),n("div",Xs,[(i(!0),n(x,null,P(H.value,a=>(i(),n("div",{key:a.id,class:"order-card"},[s("div",Ys,[s("div",Zs,[s("span",st,"订单号: "+o(a.orderNo||a.id),1),s("span",tt,[t[8]||(t[8]=s("svg",{class:"icon-clock",width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor"},[s("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"})],-1)),A(" 下单时间: "+o(S(a.createdAt||a.createTime||a.time)),1)])]),s("div",{class:N(["order-status",U(a)])},o(J(a)),3)]),s("div",et,[s("div",at,[s("div",lt,o(a.goodsName||a.title||a.productName||"商品"),1),s("div",ot,[a.productType||a.category?(i(),n("div",it,[t[9]||(t[9]=s("span",{class:"detail-label"},"商品类型:",-1)),s("span",nt,o(a.productType||a.category||"虚拟商品"),1)])):v("",!0),a.specifications||a.spec?(i(),n("div",ct,[t[10]||(t[10]=s("span",{class:"detail-label"},"规格:",-1)),s("span",dt,o(a.specifications||a.spec||"标准版"),1)])):v("",!0),s("div",ut,[t[11]||(t[11]=s("span",{class:"detail-label"},"数量:",-1)),s("span",rt,o(a.quantity||1),1)]),a.payMethod?(i(),n("div",vt,[t[12]||(t[12]=s("span",{class:"detail-label"},"支付方式:",-1)),s("span",pt,o(j(a.payMethod)),1)])):v("",!0),a.paidAt||a.payTime?(i(),n("div",mt,[t[13]||(t[13]=s("span",{class:"detail-label"},"支付时间:",-1)),s("span",_t,o(S(a.paidAt||a.payTime)),1)])):v("",!0)])]),s("div",yt,[s("div",ht,"¥"+o($(a.totalAmount||a.amount)),1),a.price?(i(),n("div",gt," 单价: ¥"+o($(a.price)),1)):v("",!0)])]),s("div",ft,[us(a)?(i(),n("button",{key:0,class:"action-btn secondary",onClick:h=>vs(a)}," 取消订单 ",8,kt)):v("",!0),Q(a)?(i(),n("button",{key:1,class:"action-btn warning",onClick:h=>ms(a)}," 查看回执单 ",8,bt)):v("",!0),rs(a)&&!Q(a)?(i(),n("button",{key:2,class:"action-btn primary",onClick:h=>ps(a)}," 查看发货信息 ",8,Ct)):v("",!0),s("button",{class:"action-btn secondary",onClick:h=>ks(a)}," 查看详情 ",8,wt)])]))),128))])),r.value.totalPage>1?(i(),n("div",Mt,[s("button",{disabled:r.value.page<=1,onClick:t[0]||(t[0]=a=>F(r.value.page-1)),class:"page-btn"}," 上一页 ",8,St),s("div",Nt,[(i(!0),n(x,null,P(ds(),a=>(i(),n("button",{key:a,class:N(["page-number",{active:a===r.value.page}]),onClick:h=>F(a)},o(a),11,Tt))),128))]),s("button",{disabled:r.value.page>=r.value.totalPage,onClick:t[1]||(t[1]=a=>F(r.value.page+1)),class:"page-btn"}," 下一页 ",8,$t),s("div",Dt," 第 "+o(r.value.page)+" 页，共 "+o(r.value.totalPage)+" 页，"+o(r.value.total)+" 条记录 ",1)])):v("",!0)])),I.value?(i(),n("div",{key:2,class:"modal-mask",onClick:os(X,["self"])},[s("div",xt,[s("div",{class:"modal-header"},[t[14]||(t[14]=s("h3",{class:"modal-title"},"订单详情",-1)),s("button",{class:"modal-close",onClick:X},"×")]),d.value?(i(),n("div",Pt,[s("div",At,[t[21]||(t[21]=s("h4",null,"订单信息",-1)),s("div",Rt,[s("div",Ot,[t[15]||(t[15]=s("span",{class:"label"},"订单号:",-1)),s("span",Et,o(d.value.orderNo||d.value.id),1)]),s("div",It,[t[16]||(t[16]=s("span",{class:"label"},"商品名称:",-1)),s("span",Vt,o(d.value.goodsName||d.value.title),1)]),s("div",Bt,[t[17]||(t[17]=s("span",{class:"label"},"订单状态:",-1)),s("span",{class:N(["value status",U(d.value)])},o(J(d.value)),3)]),s("div",Lt,[t[18]||(t[18]=s("span",{class:"label"},"下单时间:",-1)),s("span",Ft,o(S(d.value.createdAt||d.value.createTime||d.value.time)),1)]),d.value.paidAt||d.value.payTime?(i(),n("div",Kt,[t[19]||(t[19]=s("span",{class:"label"},"支付时间:",-1)),s("span",zt,o(S(d.value.paidAt||d.value.payTime)),1)])):v("",!0),d.value.payMethod?(i(),n("div",qt,[t[20]||(t[20]=s("span",{class:"label"},"支付方式:",-1)),s("span",Ht,o(j(d.value.payMethod)),1)])):v("",!0)])]),s("div",Jt,[t[25]||(t[25]=s("h4",null,"商品信息",-1)),s("div",Ut,[s("div",jt,[t[22]||(t[22]=s("span",{class:"label"},"商品价格:",-1)),s("span",Gt,"¥"+o($(d.value.price||d.value.amount)),1)]),s("div",Qt,[t[23]||(t[23]=s("span",{class:"label"},"购买数量:",-1)),s("span",Wt,o(d.value.quantity||1),1)]),s("div",Xt,[t[24]||(t[24]=s("span",{class:"label"},"订单总额:",-1)),s("span",Yt,"¥"+o($(d.value.totalAmount||d.value.amount)),1)])])])])):v("",!0)])])):v("",!0),B.value?(i(),Ts(As,{key:3,orderNo:((c=d.value)==null?void 0:c.orderNo)||((u=d.value)==null?void 0:u.id),productName:((p=d.value)==null?void 0:p.productName)||((m=d.value)==null?void 0:m.goodsName),isViewing:!0,onClose:ys,onSuccess:_s},null,8,["orderNo","productName"])):v("",!0),V.value?(i(),n("div",{key:4,class:"modal-mask",onClick:os(W,["self"])},[s("div",Zt,[s("div",{class:"modal-header"},[t[26]||(t[26]=s("h3",{class:"modal-title"},"发货信息",-1)),s("button",{class:"modal-close",onClick:W},"×")]),s("div",se,[g.value?(i(),n("div",te,[s("div",ee,[t[31]||(t[31]=s("h4",null,"订单信息",-1)),s("div",ae,[s("div",le,[t[27]||(t[27]=s("span",{class:"label"},"订单号:",-1)),s("span",oe,o((k=g.value.order)==null?void 0:k.orderNo),1)]),s("div",ie,[t[28]||(t[28]=s("span",{class:"label"},"商品名称:",-1)),s("span",ne,o((Y=g.value.order)==null?void 0:Y.productName),1)]),s("div",ce,[t[29]||(t[29]=s("span",{class:"label"},"发货状态:",-1)),s("span",de,o(hs((Z=g.value.order)==null?void 0:Z.deliveryStatus)),1)]),(ss=g.value.order)!=null&&ss.deliveredAt?(i(),n("div",ue,[t[30]||(t[30]=s("span",{class:"label"},"发货时间:",-1)),s("span",re,o(S((ts=g.value.order)==null?void 0:ts.deliveredAt)),1)])):v("",!0)])]),((es=g.value.deliveryRecords)==null?void 0:es.length)>0?(i(),n("div",ve,[t[32]||(t[32]=s("h4",null,"CDK信息",-1)),s("div",pe,[(i(!0),n(x,null,P(g.value.deliveryRecords,(a,h)=>(i(),n("div",{key:h,class:"cdk-item"},[s("div",me,[s("span",_e,"#"+o(h+1),1),s("span",{class:N(["cdk-status",a.deliveryStatus===1?"success":"failed"])},o(a.deliveryStatus===1?"发货成功":"发货失败"),3)]),a.cdkCode?(i(),n("div",ye,[s("input",{value:a.cdkCode,readonly:"",class:"cdk-code",ref_for:!0,ref:`cdkInput${h}`},null,8,he),s("button",{class:"copy-btn",onClick:Ne=>fs(a.cdkCode,h)},o(C.value===h?"已复制":"复制"),9,ge)])):a.deliveryContent?(i(),n("div",fe,o(gs(a.deliveryContent)),1)):v("",!0)]))),128))]),t[33]||(t[33]=s("div",{class:"cdk-tips"},[s("span",{class:"tips-icon"},"💡"),s("span",null,"请妥善保存您的CDK信息，避免泄露给他人")],-1))])):(i(),n("div",ke,t[34]||(t[34]=[s("div",{class:"empty-icon"},"📧",-1),s("div",{class:"empty-text"},"商品信息已通过邮件发送",-1),s("div",{class:"empty-desc"},[A(" 我们已将完整的商品信息和使用说明发送到您的邮箱"),s("br"),A(" 请检查收件箱和垃圾邮件文件夹 ")],-1)])))])):v("",!0)])])])):v("",!0),f.value?(i(),n("div",be,[s("div",Ce,[t[35]||(t[35]=s("span",{class:"toast-icon"},"⚠️",-1)),s("span",we,o(f.value),1)])])):v("",!0)])}}}),De=Ps(Me,[["__scopeId","data-v-6a019135"]]);export{De as default};
