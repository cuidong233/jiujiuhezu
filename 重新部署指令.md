# 修复Node.js版本后重新部署

## 🔧 已修复的问题

✅ 管理后台 Dockerfile: Node.js 18 → Node.js 20
✅ 前端 Dockerfile: Node.js 18 → Node.js 20  
✅ 后端 Dockerfile: Node.js 18 → Node.js 20

## 📋 重新部署步骤

### 1. 先上传修复后的文件到EC2

在本地执行：
```bash
# 重新打包项目
tar -czf project-fixed.tar.gz \
    --exclude="node_modules" \
    --exclude=".git" \
    --exclude="logs" \
    --exclude="*.log" \
    backend-api \
    nuxt-frontend \
    jiujiu-admin-simple \
    nginx \
    docker-compose.yml \
    .env.production

# 上传到EC2
scp -i ./jiujiu_key.pem project-fixed.tar.gz ubuntu@13.218.106.73:~/
```

### 2. 在EC2上执行部署

SSH连接到EC2：
```bash
ssh -i ./jiujiu_key.pem ubuntu@13.218.106.73
```

在EC2上执行：
```bash
# 停止现有服务
docker-compose down

# 清理旧镜像（重要！）
docker system prune -a -f

# 备份旧文件
mv backend-api backend-api.backup || true
mv nuxt-frontend nuxt-frontend.backup || true
mv jiujiu-admin-simple jiujiu-admin-simple.backup || true

# 解压新文件
tar -xzf project-fixed.tar.gz
rm project-fixed.tar.gz

# 确保.env文件配置正确
cp .env.production .env
PUBLIC_IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4)
sed -i "s/your-ec2-public-ip/$PUBLIC_IP/g" .env

# 重新构建（使用Node.js 20）
docker-compose build --no-cache

# 启动服务
docker-compose up -d

# 等待服务启动
sleep 30

# 检查服务状态
docker-compose ps
```

### 3. 验证构建成功

```bash
# 查看构建日志
docker-compose logs --tail=50

# 检查具体服务
docker-compose logs admin
docker-compose logs frontend  
docker-compose logs backend
```

### 4. 初始化数据库（如果需要）

```bash
# 等待MySQL完全启动
sleep 30

# 初始化数据库
docker exec jiujiu-backend node src/db/init.js
```

### 5. 测试访问

在浏览器访问：
- 前端: http://13.218.106.73:3000
- 管理后台: http://13.218.106.73:8080
- API: http://13.218.106.73:3001/api/health

## 🐛 如果还有问题

### 构建失败排查
```bash
# 查看详细构建日志
docker-compose build --no-cache admin 2>&1 | tee build.log

# 检查特定服务
docker-compose up admin
```

### 单独构建测试
```bash
# 进入管理后台目录
cd jiujiu-admin-simple

# 手动构建测试
docker build -t test-admin .

# 查看构建过程
docker build --no-cache -t test-admin . 2>&1 | tee build-debug.log
```

### 版本验证
```bash
# 验证Node.js版本
docker run --rm node:20-alpine node --version
# 应该显示 v20.x.x
```