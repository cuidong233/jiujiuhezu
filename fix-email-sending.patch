--- ä¿®å¤ä»£å……CDKæ‰‹åŠ¨å‘è´§é‚®ä»¶å‘é€é—®é¢˜ ---

é—®é¢˜æè¿°ï¼š
1. ä»£å……CDKï¼ˆmanual_rechargeç±»å‹ï¼‰æ‰‹åŠ¨å‘è´§åç”¨æˆ·æ²¡æœ‰æ”¶åˆ°é‚®ä»¶
2. å‰å°çŠ¶æ€å¯èƒ½ä¸æ›´æ–°

æ ¹æœ¬åŸå› åˆ†æï¼š
1. é‚®ä»¶æœåŠ¡å¯èƒ½æœªæ­£ç¡®é…ç½®
2. é‚®ä»¶å‘é€å¤±è´¥æ—¶æ²¡æœ‰é”™è¯¯æç¤º
3. å¼‚æ­¥æ“ä½œå¯èƒ½å¯¼è‡´é‚®ä»¶å‘é€è¢«è·³è¿‡

ä¿®å¤æ–¹æ¡ˆï¼š

=== 1. æ£€æŸ¥å¹¶é…ç½®é‚®ä»¶æœåŠ¡ ===
åœ¨ backend-api/.env æ–‡ä»¶ä¸­æ·»åŠ ï¼š
```
BREVO_API_KEY=your-brevo-api-key
EMAIL_FROM_ADDRESS=noreply@yourdomain.com
EMAIL_FROM_NAME=Your Store Name
```

=== 2. ä¿®æ”¹ backend-api/src/routes/order.routes.js ===
åœ¨ç¬¬ 589-618 è¡Œçš„é‚®ä»¶å‘é€éƒ¨åˆ†ï¼Œæ·»åŠ æ›´è¯¦ç»†çš„æ—¥å¿—ï¼š

åŸä»£ç ï¼š
```javascript
// å‘é€é‚®ä»¶é€šçŸ¥ï¼ˆå¦‚æœæœ‰é‚®ç®±ï¼‰
if (order.userEmail) {
  try {
    // ... é‚®ä»¶å‘é€ä»£ç 
  } catch (emailError) {
    console.error('å‘é€é‚®ä»¶å¤±è´¥:', emailError);
  }
}
```

ä¿®æ”¹ä¸ºï¼š
```javascript
// å‘é€é‚®ä»¶é€šçŸ¥ï¼ˆå¦‚æœæœ‰é‚®ç®±ï¼‰
if (order.userEmail) {
  console.log(`ğŸ“§ å‡†å¤‡å‘é€æ‰‹åŠ¨å‘è´§é‚®ä»¶åˆ°: ${order.userEmail}`);
  
  try {
    // è·å–å•†å“ä¿¡æ¯
    const product = await Product.findByPk(order.productId);
    
    // å‡†å¤‡é‚®ä»¶æ•°æ®
    const emailData = {
      userEmail: order.userEmail,
      orderNo: order.orderNo,
      productName: product ? (product.title || product.name) : 'å•†å“',
      productInfo: additionalInfo || product?.description || '',
      amount: order.totalAmount || order.amount,
      cdkKeys: cdkCodes
    };
    
    console.log('ğŸ“§ é‚®ä»¶æ•°æ®:', JSON.stringify(emailData, null, 2));
    
    // å‘é€æ‰‹åŠ¨å‘è´§å®Œæˆé‚®ä»¶
    const brevoService = require('../services/brevoService.js').default;
    
    // æ£€æŸ¥ Brevo æ˜¯å¦åˆå§‹åŒ–
    if (!brevoService.initialized) {
      console.error('âŒ BrevoæœåŠ¡æœªåˆå§‹åŒ–ï¼Œè¯·æ£€æŸ¥ BREVO_API_KEY é…ç½®');
      throw new Error('é‚®ä»¶æœåŠ¡æœªé…ç½®');
    }
    
    const result = await brevoService.sendManualDeliveryCompleteEmail(emailData);
    
    if (result.success) {
      console.log(`âœ… å‘è´§é‚®ä»¶å‘é€æˆåŠŸ: ${order.userEmail}`);
      console.log(`   é‚®ä»¶ID: ${result.messageId}`);
    } else {
      console.error(`âŒ å‘è´§é‚®ä»¶å‘é€å¤±è´¥: ${result.message}`);
      // å¯ä»¥è€ƒè™‘æ·»åŠ é‡è¯•æœºåˆ¶
    }
  } catch (emailError) {
    console.error('âŒ å‘é€é‚®ä»¶å¼‚å¸¸:', emailError);
    console.error('   é”™è¯¯è¯¦æƒ…:', emailError.message);
    // é‚®ä»¶å‘é€å¤±è´¥ä¸å½±å“å‘è´§æµç¨‹ï¼Œä½†è¦è®°å½•é”™è¯¯
  }
} else {
  console.log('âš ï¸ è®¢å•æ²¡æœ‰ç”¨æˆ·é‚®ç®±ï¼Œè·³è¿‡é‚®ä»¶å‘é€');
}
```

=== 3. å¢å¼º brevoService.js çš„é”™è¯¯å¤„ç† ===
åœ¨ backend-api/src/services/brevoService.js ç¬¬ 243-285 è¡Œï¼š

æ·»åŠ æ›´è¯¦ç»†çš„é”™è¯¯æ—¥å¿—ï¼š
```javascript
async sendManualDeliveryCompleteEmail(orderData) {
  console.log('ğŸ“§ è°ƒç”¨ sendManualDeliveryCompleteEmail');
  console.log('   åˆå§‹åŒ–çŠ¶æ€:', this.initialized);
  
  if (!this.initialized) {
    console.log('âŒ Brevoæœªåˆå§‹åŒ–ï¼Œè·³è¿‡é‚®ä»¶å‘é€');
    console.log('   è¯·æ£€æŸ¥ BREVO_API_KEY æ˜¯å¦é…ç½®');
    return { success: false, message: 'Brevoæœªé…ç½®' };
  }

  try {
    const { userEmail, orderNo, productName, productInfo, amount, cdkKeys } = orderData;
    
    console.log(`ğŸ“§ å‡†å¤‡å‘é€æ‰‹åŠ¨å‘è´§é‚®ä»¶:`);
    console.log(`   æ”¶ä»¶äºº: ${userEmail}`);
    console.log(`   è®¢å•å·: ${orderNo}`);
    console.log(`   å•†å“: ${productName}`);
    console.log(`   CDKæ•°é‡: ${cdkKeys?.length || 0}`);

    // ... å…¶ä½™ä»£ç ä¿æŒä¸å˜

    const response = await this.apiInstance.sendTransacEmail(sendSmtpEmail);
    
    const messageId = response?.body?.messageId || response?.messageId || 'unknown';
    
    console.log(`âœ… æ‰‹åŠ¨å‘è´§å®Œæˆé‚®ä»¶å‘é€æˆåŠŸ!`);
    console.log(`   è®¢å•: ${orderNo}`);
    console.log(`   é‚®ä»¶ID: ${messageId}`);
    
    return { 
      success: true, 
      message: 'é‚®ä»¶å‘é€æˆåŠŸ',
      messageId: messageId 
    };
  } catch (error) {
    console.error('âŒ å‘é€æ‰‹åŠ¨å‘è´§å®Œæˆé‚®ä»¶å¤±è´¥!');
    console.error('   é”™è¯¯ç±»å‹:', error.name);
    console.error('   é”™è¯¯ä¿¡æ¯:', error.message);
    console.error('   é”™è¯¯è¯¦æƒ…:', error.response?.body || error);
    
    return { 
      success: false, 
      message: error.message || 'é‚®ä»¶å‘é€å¤±è´¥'
    };
  }
}
```

=== 4. å‰ç«¯çŠ¶æ€æ›´æ–°ä¼˜åŒ– ===
åœ¨ jiujiu-admin-simple/src/views/Order.vue ç¬¬ 1285-1292 è¡Œï¼š

ç¡®ä¿å‘è´§æˆåŠŸååˆ·æ–°è®¢å•åˆ—è¡¨ï¼š
```javascript
if (response.data.code === 200) {
  ElMessage.success('å‘è´§æˆåŠŸ')
  deliveryDialogVisible.value = false
  
  // ç«‹å³åˆ·æ–°è®¢å•åˆ—è¡¨
  await fetchOrders()
  
  // æ›´æ–°å…¨å±€å¾…å‘è´§æ•°é‡
  globalPendingDeliveryCount.value = Math.max(0, (globalPendingDeliveryCount.value || 1) - 1)
  
  // å¯é€‰ï¼šæ˜¾ç¤ºé‚®ä»¶å‘é€çŠ¶æ€
  if (response.data.data?.emailSent) {
    ElMessage.success('é‚®ä»¶é€šçŸ¥å·²å‘é€')
  }
}
```

=== 5. æµ‹è¯•æ­¥éª¤ ===
1. ç¡®ä¿ BREVO_API_KEY å·²é…ç½®
2. é‡å¯åç«¯æœåŠ¡
3. åœ¨ç®¡ç†åå°æ‰¾åˆ°ä¸€ä¸ªä»£å……è®¢å•
4. ç‚¹å‡»"å‘è´§"æŒ‰é’®
5. è¾“å…¥CDKç å’Œé™„åŠ ä¿¡æ¯
6. ç¡®è®¤å‘è´§
7. æ£€æŸ¥ï¼š
   - æ§åˆ¶å°æ—¥å¿—æ˜¯å¦æ˜¾ç¤ºé‚®ä»¶å‘é€æˆåŠŸ
   - è®¢å•çŠ¶æ€æ˜¯å¦æ›´æ–°ä¸º"å·²å‘è´§"
   - ç”¨æˆ·é‚®ç®±æ˜¯å¦æ”¶åˆ°é‚®ä»¶

=== 6. æ•…éšœæ’æŸ¥ ===
å¦‚æœé‚®ä»¶ä»ç„¶æ²¡æœ‰å‘é€ï¼Œæ£€æŸ¥ï¼š
1. backend-api/.env ä¸­çš„ BREVO_API_KEY æ˜¯å¦æœ‰æ•ˆ
2. æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯æ—¥å¿—
3. ç”¨æˆ·é‚®ç®±åœ°å€æ˜¯å¦æœ‰æ•ˆ
4. Brevo è´¦æˆ·æ˜¯å¦æœ‰è¶³å¤Ÿçš„é¢åº¦
5. é‚®ä»¶æ˜¯å¦è¢«å½’ç±»ä¸ºåƒåœ¾é‚®ä»¶